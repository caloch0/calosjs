(function(w){function loadScript(path){var node=document.createElement('script')node.type='text/javascript'node.src=path+'?_='+(new Date().getTime())document.body.appendChild(node)}function loadScripts(){for(let i=0;i<arguments.length;i++){const el=arguments[i];loadScript(el)}}function redirect(path){location.href=path}function getHtmlOrJson(url,success){function makeHttpObject(){if("XMLHttpRequest"in window)return new XMLHttpRequest();else if("ActiveXObject"in window)return new ActiveXObject("Msxml2.XMLHTTP")}var request=makeHttpObject();request.open("GET",url+"?"+new Date().getTime(),true);request.send(null);request.onreadystatechange=function(){if(request.readyState==4){success(request.responseText)}}}function getQueryJson(route){let arr=route.split("?")[1].split("&");let queryJson={};for(let i of arr){queryJson[i.split("=")[0]]=i.split("=")[1]}return queryJson}function whenready(onload){document.body.onload=onload}window.loadedScripts=[];function require(file,callback){if(window.loadedScripts.indexOf(file)===-1){var script=document.createElement("script");script.src=file;if(callback){script.onreadystatechange=function(){if(script.readyState==="loaded"||script.readyState==="complete"){script.onreadystatechange=null;window.loadedScripts.push(file)callback()}};script.onload=function(){callback()}}document.documentElement.firstChild.appendChild(script)}}function requireAll(scripts){let promises=[];scripts.filter(s=>window.loadedScripts.indexOf(s)===-1).forEach(function(url){var loader=new Promise(function(resolve,reject){let script=document.createElement('script');script.src=url;script.async=false;script.onload=function(){window.loadedScripts.push(url)resolve(url)};script.onerror=function(){reject(url)};document.body.appendChild(script)});promises.push(loader)});return Promise.all(promises).then(function(){console.log('all scripts loaded')}).catch(function(script){console.log(script+' failed to load')})}const utils={loadScript,loadScripts,redirect,getQueryJson,getHtmlOrJson,whenready,require,requireAll,}for(const i in utils){w[i]=utils[i]}})(window);(function(w){function renderScope(data,scope,prefix,xPath){if(xPath)xPath=xPath+"."for(const name in data){if(Object.hasOwnProperty.call(data,name)){const fieldValue=data[name];var selector=prefix+name var fullPath=xPath+name if(isValType(fieldValue)){const els=getElsByFieldName(scope,selector)els.forEach(el=>{SetValue(el,fieldValue)el.dataset.xpath=fullPath})}else if(isObjectType(fieldValue)){const els=getElsByFieldName(scope,selector)els.forEach(el=>{el.dataset.xpath=fullPath renderScope(fieldValue,el,"",fullPath)})}else if(isArrayType(fieldValue)){const els=scope.querySelectorAll("[\\@field^="+selector+"\\|]")els.forEach(el=>{const subAlias=el.getAttribute("@field").split('|')[1]let ci=0 let lastCursor=el fieldValue.forEach(val=>{clone=el.cloneNode(true)clone.style.display=''clone.setAttribute("poped","true")fullPath=xPath+name+`[${ci}]`clone.dataset.xpath=fullPath clone.dataset.index=ci insertAfter(clone,lastCursor)lastCursor=clone if(isValType(val))SetValue(clone,val)else renderScope(val,clone,subAlias+".",fullPath)ci++el.style.display='none'})})}}}const els=scope.querySelectorAll("[\\@field]")els.forEach(el=>{const dataPath=el.getAttribute("@field")if(dataPath.indexOf('.')!==-1){try{var v=eval("data."+dataPath)if(isValType(v)){el.dataset.xpath=dataPath SetValue(el,v)}}catch{}}})}function init($this,el,setting){$this.default={global:{},model:{}}$this.settings=setting||$this.default $this.rootel=el $this.refs={}let refs=el.querySelectorAll('[ref]')refs.forEach(r=>{let refName=r.getAttribute('ref')$this.refs[refName]=r})$this.homeTemplate=encodeURIComponent(el.innerHTML)$this.homeSettings=$this.settings}var calo=function(el,setting){init(this,el,setting)calo.run.apply(this)}calo.prototype={getElsByxpath:function(xpath){return this.rootel.querySelectorAll(`[data-xpath='${xpath}']`)},makePlugin:function(idOrEl,functionPlugin){if(idOrEl instanceof HTMLElement)functionPlugin.call(this,idOrEl)else functionPlugin.call(this.settings,document.getElementById(idOrEl))calo.run.apply(this)},callPlugin:function(el,functionPlugin){let args=[el]for(let i=2;i<arguments.length;i++){args.push(arguments[i])}functionPlugin.apply(this,args)calo.run.apply(this)},reload:function(){this.rootel.innerHTML=decodeURIComponent(this.homeTemplate)init(this,this.rootel,this.homeSettings)calo.run.apply(this)},navi(url,app){this.settings=null app.navigate(url)}}function removePoppedbyScope(scopeEl){var poped=scopeEl.querySelectorAll("[poped='true']")poped.forEach(p=>{p.remove()})}calo.run=function(){if(this.settings===null)return this.current=this var target=this var root=target.rootel removePoppedbyScope(root)renderScope({...target.settings.global,...target.settings.model},root,"","")var clicks=root.querySelectorAll("[\\@Click]")var changes=root.querySelectorAll("[\\@Change]")clicks.forEach(c=>{c.onclick=function(e){target.settings[c.getAttribute("@Click")].call(target,c,c.value)calo.run.apply(target)}})changes.forEach(c=>{c.onchange=function(){target.settings[c.getAttribute("@Change")].call(target,c,c.value)calo.run.apply(target)}})root.querySelectorAll("[\\@Show]").forEach(el=>{const field=el.getAttribute("@Show")const flag=calo.model[field]el.style.display=flag===true?'':'none'})var links=root.querySelectorAll("[\\@Link]")links.forEach(l=>{l.onclick=function(e){e.preventDefault();if(target.navigate){var dest=l.getAttribute("@Link")target.navigate(dest)}}})applySameFieldKeyupChange("input[type=text]")applySameFieldKeyupChange("textarea")applySameFieldKeyupChange("input[type=date]")applySameFieldKeyupChange("input[type=password]")applySameFieldKeyupChange("input[type=number]")applySameFieldClickChange("input[type=checkbox]")applySameFieldClickChange("input[type=radio]",function(el){if(el.name){const groupname=el.name const group=root.querySelectorAll(`input[type=radio][name=${groupname}]`)for(let i=0;i<group.length;i++){if(i==0)continue;const el1=group[i];if(!el1.isEqualNode(el)){eval("target.settings.model."+el1.dataset.xpath+"=false")}}}})applySameFieldSelectChange()function applySameFieldKeyupChange(tag){root.querySelectorAll(tag).forEach(ip=>{if(window.addEventListener){ip.addEventListener('keyup',function(e){e.preventDefault()e.stopPropagation()eval("target.settings.model."+ip.dataset.xpath+"='"+ip.value+"'")root.querySelectorAll(`[data-xpath='${ip.dataset.xpath}']`).forEach(el=>{SetValue(el,ip.value)})},false)}else{ip.attachEvent('change',function(){console.log(5)})}})}function applySameFieldClickChange(tag,pre){root.querySelectorAll(tag).forEach(ipc=>{ipc.onclick=function(){if(pre)pre(this)var val=this.checked var xpath=this.dataset.xpath eval("target.settings.model."+xpath+"='"+val+"'")const nodes=root.querySelectorAll(`[data-xpath='${xpath}']`);nodes.forEach(el=>{SetValue(el,val)})}})}function applySameFieldSelectChange(){root.querySelectorAll("Select").forEach(ipc=>{ipc.onchange=function(){const selected=this.value var xpath=ipc.dataset.xpath eval("target.settings.model."+xpath+"='"+selected+"'")const nodes=root.querySelectorAll(`[data-xpath='${xpath}']`);nodes.forEach(el=>{SetValue(el,selected)})}})}}function SetValue(el,val){if(el.tagName==="INPUT"&&el.type==="text")el.value=val else if(el.tagName==="INPUT"&&el.type==="password")el.value=val else if(el.tagName==="INPUT"&&el.type==="date")el.value=val else if(el.tagName==="INPUT"&&el.type==="number")el.value=val else if(el.tagName==="TEXTAREA")el.value=val else if(el.tagName==="A")el.href=val else if(el.tagName==="INPUT"&&el.type==="checkbox")el.checked=val else if(el.tagName==="INPUT"&&el.type==="radio")el.checked=val else if(el.tagName==="BUTTON"){const dataName=el.getAttribute("@field")el.dataset[dataName]=val}else if(["LABEL","SPAN","OPTION","H2","H1","H3","P","DIV","LI"].indexOf(el.tagName)!==-1){el.innerHTML=val}else if(el.tagName==='SELECT'){el.value=val}}function getElsByFieldName(scope,fieldName){return scope.querySelectorAll("[\\@field='"+fieldName+"'")}function isValType(obj){return typeof obj==="number"||typeof obj==="string"||typeof obj==="boolean"}function isArrayType(obj){return obj instanceof Array}function isObjectType(obj){return!(obj instanceof Array)&&typeof obj==="object"}function insertAfter(newElement,targetElement){var parent=targetElement.parentNode;if(parent.lastChild==targetElement){parent.appendChild(newElement)}else{parent.insertBefore(newElement,targetElement.nextSibling)}}w.calo=calo})(window);function routerExtend(o,routes){o.spaPath=o.spaPath||"./"o.templateStorage=o.templateStorage||{}const root=o.rootel;const routerel=o.rootel.querySelector("[\\@Router]")o.navigate=function(route,isHistory){if(!window.templateLoaded&&route!=="/"){console.log("only route template is loaded, rquesting others cannot succeed")return}if(isHistory){window.history.pushState({route},'',route)}else{location.href=location.href.split('#')[0]+'#'+route}if(route.indexOf('?')!==-1){o.query=getQueryJson(route)const parts=route.split('?')route=parts[0]}else{o.query={}}if(!o.templateStorage[route.toLowerCase()]&&route!=='/'){var pagePath=o.spaPath+route.substr(1)+".html"getHtmlOrJson(pagePath+"?_="+Math.random(),function(text){o.templateStorage[route.toLowerCase()]=encodeURIComponent(text);makePage(route,o)})}else return makePage(route,o)}router(routes)function makePage(route,o){var navPage root.innerHTML=''var hm=stringToHTML(decodeURIComponent(o.templateStorage[route.toLowerCase()]))var scriptBlock=hm.getElementsByTagName('script')[0]var script=scriptBlock?scriptBlock.text:''if(!routerel)root.innerHTML=hm.innerHTML else routerel.innerHTML=hm.innerHTML if(script){var page if(route!=="/"){eval(script)if(!Page){{console.log('Page should have function Page')};return}page=new Page(o.query,o)}page.settings.global={...o.settings?.global,...page.settings?.global}navPage=new calo(o.rootel,page.settings)navPage.parent=o o.current=navPage o.currentReqs=[]o.settings=navPage.settings}if(route==="/"){o.reload()return}return navPage}function stringToHTML(str){var parser=new DOMParser();var doc=parser.parseFromString(str,'text/html');return doc.body};function router(routes){o.homeSettings=o.settings var router=o.settings.routes||{}router={...router,...routes}var proms=[]for(const key in router){if(Object.hasOwnProperty.call(router,key)){const keyLower=key.toLowerCase()var p=new Promise(resolve=>{const htmlName=router[key];getHtmlOrJson(o.spaPath+htmlName+"?_="+Math.random(),function(text){o.templateStorage[keyLower]=encodeURIComponent(text);resolve()})})proms.push(p)}}Promise.all(proms).then(function(){window.templateLoaded=true console.log('all templates have been loaded')if(location.href.indexOf('#')!==-1){var path=location.href.split('#')[1]o.navigate(path)}})}return o}function ajaxExtend(o){o.ajax=ajax o.ajaxJson=ajaxJson o.ajaxQueue=ajaxQueue function ajaxQueue(req){if(!ajaxQueue.queue)ajaxQueue.queue=[]if(req)ajaxQueue.queue.push(req)if(ajaxQueue.locked)return if(ajaxQueue.queue.length>0){if(!ajaxQueue.locked){const{url,data,type,success,error}=ajaxQueue.queue[0]ajaxQueue.locked=true ajax({url:url,data:data,type:type,success:function(resp){success(resp)ajaxQueue.queue.shift()ajaxQueue.locked=false ajaxQueue()},error:function(){error()ajaxQueue.locked=false ajaxQueue()}})}}}function ajaxJson(req,beforeSend){const{url,data,type,success,error}=req o.currentReqs=o.currentReqs||[]o.currentReqs.push(req)type=type||"get";data=data||{};let str="";for(let i in data){str+=`${i}=${data[i]}&`}str=str.slice(0,str.length-1);if(type==="get"){var d=new Date();url=url+"?"+str+"&__qft="+d.getTime()}let xhr=new XMLHttpRequest();xhr.open(type,url,true);if(beforeSend)beforeSend(xhr);if(type==="get"){xhr.send()}else if(type==="post"){xhr.setRequestHeader("Content-type","application/json");xhr.send(JSON.stringify(data))}xhr.onload=function(){if(xhr.status===200){if(o.currentReqs.indexOf(req)!==-1){success.call(o.current,JSON.parse(xhr.responseText))calo.run.apply(o.current)}}else{error&&error(xhr.status)}}}function ajax(req,beforeSend){const{url,data,type,success,error}=req o.currentReqs=o.currentReqs||[]o.currentReqs.push(req)type=type||"get";data=data||{};let str="";for(let i in data){str+=`${i}=${data[i]}&`}str=str.slice(0,str.length-1);if(type==="get"){var d=new Date();url=url+"?"+str+"&__qft="+d.getTime()}let xhr=new XMLHttpRequest();xhr.open(type,url,true);if(beforeSend)beforeSend(xhr);if(type==="get"){xhr.send()}else if(type==="post"){xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");xhr.send(str)}xhr.onload=function(){if(xhr.status===200){if(o.currentReqs.indexOf(req)!==-1){success.call(o.current,JSON.parse(xhr.responseText))calo.run.apply(o.current)}}else{error&&error(xhr.status)}}}return o}